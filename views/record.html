{{ extend './_layouts/home.html' }}
{{ block 'title' }}{{ '運動紀錄' }}{{ /block }}
{{ block 'head' }}
<link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css">
<link rel="stylesheet" href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<style>
  img {
    width: 75vw;
    height: 25vh;
  }

  .flickity-page-dots {
    bottom: 0px;
  }

  /* white circles */
  .flickity-page-dots .dot {
    width: 12px;
    height: 12px;
    opacity: 1;
    background: transparent;
    border: 2px solid white;
  }

  /* fill-in selected dot */
  .flickity-page-dots .dot.is-selected {
    background: white;
  }
</style>
{{ /block }}
{{ block 'body' }}
<!-- Begin Page Content -->
<div class="container-fluid">
  <!-- DataTales Example -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">請選擇運動器材</h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <div class="main-carousel">
          {{ each Equipments }}
          <div data-eqid='{{ $value._id }}' data-equipName='{{ $value.name }}' class="carousel-cell">
            <img src="{{ $value.picUrl }}" alt="">
            <p style="text-align:center;">{{ $value.name }}</p>
          </div>
          {{ /each }}
        </div>
        <div>
          <input type="hidden" name="psid" id="psid" value="{{ User.id }}">
          <p>
            <label for="weight">請輸入重量:</label>
            <input min="0" class="form-control form-control-user" type="number" name="weight" id="weight"
              placeholder="重量(單位：磅)">
          </p>
          <p>
            <label for="times">請輸入次數:</label>
            <input min="0" class="form-control form-control-user" type="number" name="times" id="times"
              placeholder="請輸入次數">
          </p>
          <p>
            <a id="aSend" href="#" class="btn btn-primary btn-user btn-block">
              送出
            </a>
          </p>
        </div>
        <div>
          <h6 class="m-0 font-weight-bold text-primary">該項目本日紀錄</h6>
          <table style="margin-top: 5px;" id='tableTodayRecord'>
            <thead>
              <tr>
                <th>重量(磅/kg)</th>
                <th>重複次數</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /.container-fluid -->
{{ /block }}
{{ block 'script' }}
<script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>
<script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script>
  var flkty = null
  var dataTable=null
  $(document).ready(() => {
    var carousel = $('.main-carousel').flickity({
      cellAlign: 'left',
      contain: true,
      on: {
        'change': () => {
          fnGetRecordOfEquipment()
        }
      }
    })
    flkty = carousel.data('flickity')    
    $('#aSend').click(function (e) {
      e.preventDefault()
      var data = {
        psid: $('input[name="psid"]').val(),
        equipment: $(flkty.selectedElement).attr('data-eqid'),
        equipmentName: $(flkty.selectedElement).attr('data-equipName'),
        weight: parseInt($('input[name="weight"]').val()),
        times: parseInt($('input[name="times"]').val())
      }
      if (data.equipment.length <= 0) {
        alert('請選擇器材')
        return
      }
      if (isNaN(data.weight)) {
        alert('請輸入重量')
        return
      }
      if (isNaN(data.times)) {
        alert('請輸入每組次數')
        return
      }
      $.ajax({
        url: '/record',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data)
      }).done((result) => {
        if (result.code === 200) {
          fnGetRecordOfEquipment()
        } else {
          alert('伺服器忙碌中,請稍後再試')
        }
      })
    })
    fnInitializeTable()
    fnGetRecordOfEquipment()
  })
  var fnGetRecordOfEquipment = () => {
    var eqid = $(flkty.selectedElement).attr('data-eqid')
    var psid = $('input[name="psid"]').val()
    var url = `/GetRecordOfEquipment?eqid=${eqid}&psid=${psid}`
    dataTable.ajax.url(url).load()
  }
  var fnInitializeTable = () => {
    dataTable=$('#tableTodayRecord').DataTable({
      'paging': false,
      'info': false,
      'searching': false,
      'language':
      {
        'emptyTable':'本日尚未有紀錄'
      },
      'columns':[
        {data:'weight'},
        {data:'times'}
      ]
    })
  }
</script>
<!-- Page level plugins -->
{{ /block }}